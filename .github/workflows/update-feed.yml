name: Update feed.xml automatically
on:
  push:
    branches: [ "main" ]
    paths:
      - "stories/**.html"

jobs:
  update-feed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate or update feed.xml
        run: |
          echo "ðŸ”„ Updating feed.xml ..."
          FEED="feed.xml"
          SITE="https://dailypixelsite.github.io"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create feed.xml if it doesn't exist
          if [ ! -f "$FEED" ]; then
            echo '<?xml version="1.0" encoding="utf-8"?>' > $FEED
            echo '<feed xmlns="http://www.w3.org/2005/Atom">' >> $FEED
            echo "  <title type=\"html\">Daily Pixel â€” New Stories</title>" >> $FEED
            echo "  <id>${SITE}/feed.xml</id>" >> $FEED
            echo "  <updated>${DATE}</updated>" >> $FEED
          else
            # remove the closing </feed> for appending
            sed -i '/<\/feed>/d' $FEED
          fi

          # Find latest added or modified story
          FILE=$(git diff --name-only HEAD~1 HEAD | grep '^stories/.*\.html' | tail -n 1)
          if [ -z "$FILE" ]; then
            echo "No new story found."
            exit 0
          fi

          echo "ðŸ“„ Found new story: $FILE"

          # Extract title text between <title> tags
          TITLE=$(grep -m1 "<title>" "$FILE" | sed -E 's/.*<title>(.*)<\/title>.*/\1/')
          # Extract first paragraph as summary
          SUMMARY=$(grep -m1 "<p" "$FILE" | sed -E 's/.*<p[^>]*>(.*)<\/p>.*/\1/' | sed 's/"/&quot;/g')

          LINK="${SITE}/${FILE}"

          echo "ðŸ“° Adding entry for: $TITLE"

          echo "  <entry>" >> $FEED
          echo "    <title>${TITLE}</title>" >> $FEED
          echo "    <link href=\"${LINK}\" />" >> $FEED
          echo "    <id>${LINK}</id>" >> $FEED
          echo "    <updated>${DATE}</updated>" >> $FEED
          echo "    <summary>${SUMMARY:-New story published on Daily Pixel.}</summary>" >> $FEED
          echo "  </entry>" >> $FEED
          echo "</feed>" >> $FEED

      - name: Commit feed.xml changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add feed.xml
          git commit -m "Auto update feed.xml with new story"
          git push
